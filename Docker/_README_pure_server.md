# Instructions to run a openroberta-lab server using DOCKER

**Note (from 08.05.2021): this text has to be proof-read by openroberta lab members or by *you*. Use the mail address from the end of this text!**

A lot of people around the world, teachers and students, have no good internet connection or other good reasons not to use our online lab at
https://lab.open-roberta.org. This text explains how to run a local server. The network the server is part of
may be the network of a school (connected to the internet or not) or a computer with an dedicated router creating a network of its own.

**This document describes the preferred way to run a local lab.** To have a real lightweight setup and operating, we are using `docker`.
To use this setup, you have to install docker on the computer on which the lab runs. You can run the lab on windows10, linux system (Ubuntu, Debian, ...)
and RaspberryPI.
  
# Initial Setup and First Run

For the initial setup you need access to the internet. When the lab is running later, this is *not* required.

* First install `docker` on your computer. Check, that the docker demon is working. You'll find a lot of resources on the internet about installation and checking.
* select a directory for the data base. The directory may not exist or be empty. In this case an empty data base is created automatically. Otherwise it must contain a valid
  data base, for instance from earlier runs of the lab.
* you have to select the version of the lab server. If you look at `https://hub.docker.com/repository/docker/openroberta/standalone_x64` (or `..._arm32v7`), you get a list
  of the versions ("tags") we have stored at dockerhub. Probably you will select the highest version number for your local server. Currently the version is 4.1.2.
  From time to time you may look for newer versions and switch to it.
* When the docker command below is executed for the first time, this takes some time, because the lab image is pulled from dockerhub.
* start the lab using a command from the example section below. The container gets the name you select, in the example `my-local-lab`.
  The last parameter specifies the robots your server will support. The internal port 1999
  is mapped to the external port 2222 (you can change it, 80 would be a sensible value :-).
* Check for success, e.g. `docker ps` or using the docker desktop. The container should be running.
* Assuming, that your computer name is `squirrel`, point your browser to `squirrel:2222`, write a small program and run the simulator to check your installation.

* Later you may stop the container: `docker stop my-local-lab` and remove them: `docker rm my-local-lab`. If you don't remove the container, you have
  to select new names for every start. You may omit the `--name` parameter and get a name generated by docker, but: be careful to remove exited container,
  they waste space!

# Regular Operation

* switch your computer on, start the docker demon, start the lab. That's it. 

# Remarks

* Docker depends on the hardware architecture. We support `x64` or `arm32v7`. `x64` is the *most* used architecture (for windows, linux on
  desktop, workstations, ...). For all x64 machines *exactly* the same docker image is used, thus the behavior of the lab on all x64 system is *identical*.
  `arm32v7` is for all versions of the RaspberryPI.
* logging of the lab server goes to the console. Using the docker desktop, you may have a look onto it.
* when you specify the data base directory, use always a full path (as in the examples)
* you may want to run the start of the lab as init commands. There are descriptions on the net how to do that for all operating systems.
* the list of all plugins available currently is:
  `sim,wedo,ev3lejosv1,ev3lejosv0,ev3dev,ev3c4ev3,nxt,microbit,botnroll,nao,bob3,sensebox,mbot,edison,festobionic,uno,unowifirev2,nano,mega,calliope2017NoBlue,calliope2017,calliope2016`.
* if the lab is stopped, you may backup the data base by simply copying, zipping or tarring the data base directory.
* if you need more robust operation of the server, e.g.
  * data base backup. This makes sense, though you can simply copy the data base files after the db server has been stopped (or zip them to a backup file).
  * automatic restart if the server is frozen. This is unlikely to happen, but if the server is unattended, it makes sense.
  * a web server as apache or nginx in front of the lab server
  ... then you should use the docker setup of our prod lab, which has this and more. It is more demanding from a technical point of view, but described in our 
  git repo in file `Docker/_README.md` in detail.

# Examples

On my windows 10 I start the lab from `cmd` with a data base located at `D:\data\db`:
```sh
docker run -d --name my-local-lab -p 2222:1999 -v D:\data\db:/opt/db openroberta/standalone-x64:4.1.2 -d robot.whitelist=sim,ev3lejosv1,nano,calliope2017NoBlue,microbit
```

On my ubuntu18 I start the lab from `bash` with a data base located at `/data/db`:
```sh
docker run -d --name my-local-lab -p 2222:1999 -v /data/db:/opt/db openroberta/standalone-x64:4.1.2 -d robot.whitelist=sim,ev3lejosv1,nano,calliope2017NoBlue,microbit
```

On my RaspberryPI 3 I start the lab from `bash` with a data base located at `/data/db`:
```sh
docker run -d --name my-local-lab -p 2222:1999 -v /data/db:/opt/db openroberta/standalone-arm32v7:4.1.2 -d robot.whitelist=sim,ev3lejosv1,nano,calliope2017NoBlue,microbit
```

The following init script works for linux and RaspberryPI. First it stops and removes all containers, then for start and restart it starts the standalone lab.
Obviously this script *only* works as expected if no other container are running on that machine:
```sh
#!/bin/sh
### BEGIN INIT INFO
# Provides:          openrobertalab
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: standalone openrobertalab service
# Description:       Start, stop and restart the standalone lab
### END INIT INFO
docker stop $(docker ps -a -q)
docker rm $(docker ps -q -f status=exited)
case "$1" in
    start|restart) echo 'openroberta standalone lab start'
                   docker run -d -p 2222:1999 -v /data/db:/opt/db openroberta/standalone-arm32v7:4.1.2 -d robot.whitelist=sim,ev3lejosv1,nano,calliope2017NoBlue,microbit
                   ;;
    stop)          echo 'openroberta standalone lab stop'
                   ;;
    *)             echo "invalid command \"$1\" for openroberta standalone lab init script. Usage: $0 {start|stop|restart}"
                   ;;
esac
```

**do not hesitate to ask us or send corrections and proposals (e.g. mail reinhard.budde at iais.fraunhofer.de or use the gitter channel of the lab)**